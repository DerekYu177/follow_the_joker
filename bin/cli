#!/usr/bin/env ruby

require 'follow_the_joker/cli/game'
require 'follow_the_joker/version'
require 'cli'

settings = ::CLI.new do
  description 'Run Follow the Joker game via CLI'
  version FollowTheJoker::VERSION

  option(
    :shuffle_seed,
    short: :s,
    default: -1,
    cast: Integer,
    description: "Sets the value for Random.new() used for shuffling the deck",
  )
  option(
    :number_of_users,
    short: :n,
    default: 6,
    cast: Integer,
    description: "Sets the number of users. Must be an even number. Minimum 2."
  )
  option(
    :cards_for_users,
    default: "",
    cast: -> (o) { o.split(",") },
    description: "Sets the cards per user using CSV-like format. Must be equal to the number of users."
  )
end.parse! do |settings|
  unless settings.number_of_users.even? && settings.number_of_users >= 2
    fail "Number of users must be an even number >= 2"
  end

  if settings.cards_for_users.any? && settings.cards_for_users.size != settings.number_of_users
    fail "Cards (size: #{settings.cards_for_users.size}) are not equal to "\
          "the number of users (size: #{settings.number_of_users})!"
  end
end

settings.shuffle_seed = nil if settings.shuffle_seed < 0

loop { ARGV.any? ? ARGV.pop : break } # breaks CLI
FollowTheJoker::CLI::Game.new(**settings.to_h).start!
